# ShiftManager - Next Week Implementation Plan

**Created:** 2025-10-06
**Timeline:** Week of 2025-10-13 to 2025-10-17 (5 business days)
**Team Size:** Assumed 1-2 developers
**Status:** Ready for Implementation

---

## Executive Summary

This plan outlines the implementation of 5 major features for ShiftManager:

1. **Export & Print Schedules** - Enable schedule sharing via Excel/PDF exports
2. **Employee Profile Enhancements** - Expand user profiles with contact info, skills, certifications
3. **Shift Reminder Notifications** - Automated pre-shift reminders (6h and 2h before)
4. **Announcements Feed** - Top-down communication from leadership to employees
5. **Shift Analytics & Reporting** - Comprehensive workforce analytics dashboard

**Total Estimated Effort:** 120-160 developer hours (3-4 weeks for 1 developer, 1.5-2 weeks for 2 developers)

**Architecture Alignment:**
- Multi-tenant (CompanyId scoping)
- Role-based access control (Owner/Director/Manager/Employee/Trainee)
- Notification system (in-app only, no email/SMS)
- Localization support (en-US, he-IL)
- Background job infrastructure (new)

---

## Table of Contents

1. [Feature 1: Export & Print Schedules](#feature-1-export--print-schedules)
2. [Feature 2: Employee Profile Enhancements](#feature-2-employee-profile-enhancements)
3. [Feature 3: Shift Reminder Notifications](#feature-3-shift-reminder-notifications)
4. [Feature 4: Announcements Feed](#feature-4-announcements-feed)
5. [Feature 5: Shift Analytics & Reporting](#feature-5-shift-analytics--reporting)
6. [Git Branching Strategy](#git-branching-strategy)
7. [Implementation Timeline](#implementation-timeline)
8. [Testing Strategy](#testing-strategy)
9. [Deployment Checklist](#deployment-checklist)

---

## Feature 1: Export & Print Schedules

**Estimated Effort:** 24-32 hours
**Priority:** High
**Dependencies:** EPPlus (Excel) or ClosedXML, iTextSharp or QuestPDF (PDF)

### Task List

- [ ] **1.1 Research & Setup Dependencies**
  - [ ] Evaluate Excel libraries: EPPlus (paid commercial license) vs ClosedXML (free, MIT)
  - [ ] Evaluate PDF libraries: iTextSharp (LGPL/commercial) vs QuestPDF (MIT)
  - [ ] Add chosen packages to ShiftManager.csproj
  - [ ] Verify licenses comply with project requirements

- [ ] **1.2 Create Export Service**
  - [ ] Create `Services/IExportService.cs` interface
  - [ ] Create `Services/ExportService.cs` implementation
  - [ ] Method: `Task<byte[]> ExportScheduleToExcelAsync(ExportOptions options)`
  - [ ] Method: `Task<byte[]> ExportScheduleToPdfAsync(ExportOptions options)`
  - [ ] Method: `Task<byte[]> ExportEmployeeScheduleAsync(int userId, DateRange range)`
  - [ ] Register service in Program.cs

- [ ] **1.3 Define Export Models**
  - [ ] Create `Models/Export/ExportOptions.cs` (date range, filters, format)
  - [ ] Create `Models/Export/ExportFormat.cs` enum (Excel, PDF, PrintView)
  - [ ] Create `Models/Export/ExportFilterOptions.cs` (department, role, employee)
  - [ ] Create `Models/Export/ScheduleExportRow.cs` (employee, role, date, shift, city, notes)

- [ ] **1.4 Implement Excel Export**
  - [ ] Generate workbook with formatted headers
  - [ ] Include filters: company, date range, department, role
  - [ ] Columns: Employee Name, Role, Date, Shift Type, Start Time, End Time, City, Notes, Swap Indicator
  - [ ] Conditional formatting for swaps/time-offs
  - [ ] Auto-fit columns, freeze header row

- [ ] **1.5 Implement PDF Export**
  - [ ] Create printable layout (landscape A4)
  - [ ] Header: Company name, date range, export timestamp
  - [ ] Table with same columns as Excel
  - [ ] Page breaks by week (optional) or department
  - [ ] Footer: page numbers, "Generated by ShiftManager"

- [ ] **1.6 Create Print-Friendly View**
  - [ ] Create `Pages/Exports/PrintSchedule.cshtml`
  - [ ] CSS print stylesheet (hide nav, optimize layout)
  - [ ] Query parameters: date range, filters
  - [ ] Browser print dialog (Ctrl+P)

- [ ] **1.7 Build Export UI**
  - [ ] Add "Export" button to Calendar/Month, Calendar/Week, Calendar/Day
  - [ ] Create modal/dialog for export options (format, date range, filters)
  - [ ] Add "Export My Schedule" to My/Index page (employees only)
  - [ ] Add "Export" section to Admin/Reports (new page, managers+)

- [ ] **1.8 Implement Authorization**
  - [ ] Managers/Directors/Owners can export any scope
  - [ ] Employees can only export own schedule (userId validation)
  - [ ] Add `[Authorize(Policy="IsManagerOrAdmin")]` to export endpoints
  - [ ] Validate CompanyId for multi-tenant isolation

- [ ] **1.9 Testing**
  - [ ] Unit tests for ExportService (mocked data)
  - [ ] Integration test: export full month as Manager
  - [ ] Integration test: employee exports own schedule only
  - [ ] Test with 100+ shifts (performance)
  - [ ] Test with special characters in names (encoding)
  - [ ] Test timezone handling for export timestamps

### Technical Design

**Data Model Changes:** None (uses existing ShiftAssignment, ShiftInstance, AppUser)

**New Services:**
```csharp
public interface IExportService
{
    Task<byte[]> ExportScheduleToExcelAsync(DateOnly startDate, DateOnly endDate,
        int? departmentId = null, UserRole? filterRole = null, int? employeeId = null);

    Task<byte[]> ExportScheduleToPdfAsync(DateOnly startDate, DateOnly endDate,
        int? departmentId = null, UserRole? filterRole = null, int? employeeId = null);

    Task<byte[]> ExportEmployeeScheduleAsync(int userId, DateOnly startDate, DateOnly endDate);
}
```

**New API Endpoints:**
- `GET /Exports/Excel?start=2025-10-01&end=2025-10-31&role=Employee` → Download .xlsx
- `GET /Exports/Pdf?start=2025-10-01&end=2025-10-31` → Download .pdf
- `GET /Exports/MySchedule?start=2025-10-01&end=2025-10-31` → Employee-specific export

**Authorization:**
- All export endpoints require authentication
- Employee exports validated: `userId == currentUser.Id`
- Manager/Director exports validated: company access check

**Background Jobs:** None (synchronous export, <5 seconds for 1 month)

**Notifications:** None

### Dependencies

**NuGet Packages:**
- **ClosedXML** (v0.104.0) - Excel export (MIT license, free)
  ```bash
  dotnet add package ClosedXML
  ```
- **QuestPDF** (v2023.12.0) - PDF generation (MIT license, free for non-commercial)
  ```bash
  dotnet add package QuestPDF
  ```
  - ⚠️ **License Check:** QuestPDF requires commercial license for commercial use ($99/year)
  - **Alternative:** Use iTextSharp 5.5.13.3 (LGPL, free) or PdfSharpCore (MIT)

**Infrastructure:** None (in-memory generation, direct download)

### Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| **QuestPDF license cost** | Medium | Use iTextSharp (LGPL) or PdfSharpCore instead |
| **Large exports timeout (>1000 shifts)** | Medium | Add pagination; limit to 3 months max |
| **Memory issues with huge exports** | Low | Stream to file instead of byte[] in memory |
| **Special characters break Excel** | Low | Use ClosedXML encoding (handles Unicode) |
| **Timezone confusion in exports** | Medium | Always show UTC offset; include timezone in header |
| **Employee exports other users' data** | High | Strict userId validation in service layer |

---

## Feature 2: Employee Profile Enhancements

**Estimated Effort:** 32-40 hours
**Priority:** High
**Dependencies:** File upload library (built-in ASP.NET Core), image processing (optional)

### Task List

- [ ] **2.1 Database Schema Updates**
  - [ ] Extend `AppUser` model with new fields (see data model below)
  - [ ] Create `Models/EmploymentType.cs` enum (Regular, Reservee)
  - [ ] Create `Models/EmployeeProfileEdit.cs` model (audit trail)
  - [ ] Create migration `AddEmployeeProfileEnhancements`
  - [ ] Test migration up/down/up cycle

- [ ] **2.2 Create Profile Service**
  - [ ] Create `Services/IProfileService.cs` interface
  - [ ] Create `Services/ProfileService.cs` implementation
  - [ ] Method: `Task<AppUser> GetProfileAsync(int userId)`
  - [ ] Method: `Task UpdateProfileAsync(int userId, ProfileUpdateDto dto, int editorUserId)`
  - [ ] Method: `Task UploadAvatarAsync(int userId, IFormFile file)`
  - [ ] Method: `Task<List<EmployeeProfileEdit>> GetProfileAuditLogAsync(int userId)`

- [ ] **2.3 Implement Avatar Upload**
  - [ ] Create `wwwroot/avatars/` directory
  - [ ] Validate file type (PNG, JPG, WEBP only)
  - [ ] Validate file size (<2MB)
  - [ ] Resize to 200x200px (use SixLabors.ImageSharp)
  - [ ] Save as `{userId}.jpg` (overwrite existing)
  - [ ] Default avatar: initials on colored background

- [ ] **2.4 Build Profile UI**
  - [ ] Create `Pages/My/Profile.cshtml` (employee self-service)
  - [ ] Create `Pages/Admin/EmployeeProfile.cshtml?userId=X` (manager view)
  - [ ] Form sections: Contact Info, Employment Info, Skills, Emergency Contact, Notes
  - [ ] Read-only fields for sensitive data (EmploymentType, Department - managers only)
  - [ ] Avatar upload widget with preview

- [ ] **2.5 Implement Field-Level Permissions**
  - [ ] Employees can edit: PreferredName, Phone, SecondaryEmail, Avatar
  - [ ] Managers can edit: All fields except Email (email is username)
  - [ ] Owners can edit: All fields including EmploymentType, Role
  - [ ] Display permission indicators on UI (lock icon for read-only)

- [ ] **2.6 Create Profile Drawer Component**
  - [ ] Create `Pages/Shared/Components/EmployeeProfileDrawer/`
  - [ ] Triggered when clicking employee name on calendar/assignments
  - [ ] Show: Avatar, contact info, upcoming shifts (next 7 days)
  - [ ] Show: Recent shifts (last 7 days), time-off requests, swap count
  - [ ] "View Full Profile" button → redirects to Admin/EmployeeProfile

- [ ] **2.7 Build Audit Log**
  - [ ] Create `EmployeeProfileEdit` table (fields below)
  - [ ] Log all profile changes (old value → new value)
  - [ ] Display audit log on profile page (managers only)
  - [ ] Filter: last 30 days, last 90 days, all time

- [ ] **2.8 Update Calendar/Assignment Views**
  - [ ] Add employee phone number to tooltips (managers only)
  - [ ] Link employee names to profile drawer
  - [ ] Show employment type badge (R = Reservee)

- [ ] **2.9 Testing**
  - [ ] Unit tests for ProfileService (validation, permissions)
  - [ ] Test avatar upload (valid/invalid formats, size limits)
  - [ ] Test field-level permissions (employee vs manager vs owner)
  - [ ] Test audit log creation on updates
  - [ ] Test emergency contact field (required for Reservees)

### Technical Design

**Data Model Changes:**

```csharp
// Extend AppUser (add fields, no breaking changes)
public class AppUser
{
    // Existing fields...
    public int Id { get; set; }
    public int CompanyId { get; set; }
    public string Email { get; set; } = string.Empty;
    public string DisplayName { get; set; } = string.Empty;
    public UserRole Role { get; set; }
    public bool IsActive { get; set; }
    public byte[] PasswordHash { get; set; }
    public byte[] PasswordSalt { get; set; }

    // NEW FIELDS (nullable for backward compatibility)
    public string? PreferredName { get; set; }  // e.g., "Mike" instead of "Michael"
    public string? AvatarPath { get; set; }  // "/avatars/123.jpg"
    public string? City { get; set; }
    public string? Phone { get; set; }
    public string? SecondaryEmail { get; set; }
    public string? EmergencyContactName { get; set; }
    public string? EmergencyContactPhone { get; set; }
    public EmploymentType EmploymentType { get; set; } = EmploymentType.Regular;
    public string? Department { get; set; }  // Future: FK to Departments table
    public string? CertificationsJson { get; set; }  // JSON array: ["First Aid", "CPR"]
    public string? SkillsJson { get; set; }  // JSON array: ["Forklift", "Sales"]
    public string? InternalNotes { get; set; }  // Manager notes (max 2000 chars)
    public DateTime? HireDate { get; set; }
}

public enum EmploymentType
{
    Regular = 0,
    Reservee = 1
}

// New audit table
public class EmployeeProfileEdit : IBelongsToCompany
{
    public int Id { get; set; }
    public int CompanyId { get; set; }
    public int TargetUserId { get; set; }  // Employee being edited
    public AppUser TargetUser { get; set; } = null!;
    public int EditorUserId { get; set; }  // Who made the change
    public AppUser Editor { get; set; } = null!;
    public string FieldName { get; set; } = "";  // "Phone", "Department", etc.
    public string? OldValue { get; set; }
    public string? NewValue { get; set; }
    public DateTime Timestamp { get; set; } = DateTime.UtcNow;
}
```

**Migration:**
```bash
dotnet ef migrations add AddEmployeeProfileEnhancements
```

**New Services:**
```csharp
public interface IProfileService
{
    Task<AppUser> GetProfileAsync(int userId);
    Task UpdateProfileAsync(int userId, ProfileUpdateDto dto, int editorUserId);
    Task<string> UploadAvatarAsync(int userId, IFormFile file);
    Task<List<EmployeeProfileEdit>> GetProfileAuditLogAsync(int userId);
    Task<bool> CanUserEditFieldAsync(int editorUserId, int targetUserId, string fieldName);
}
```

**New Pages:**
- `Pages/My/Profile.cshtml` (employee self-service)
- `Pages/Admin/EmployeeProfile.cshtml?userId=X` (manager view with full audit)

**Authorization:**
- `My/Profile` → Authenticated (employee edits own profile)
- `Admin/EmployeeProfile` → IsManagerOrAdmin (view/edit team profiles)
- Field-level checks in ProfileService (e.g., only managers can edit InternalNotes)

**Background Jobs:** None

**Notifications:**
- None (profile updates are silent)

### Dependencies

**NuGet Packages:**
- **SixLabors.ImageSharp** (v3.0.0) - Image resizing for avatars
  ```bash
  dotnet add package SixLabors.ImageSharp
  ```

**Infrastructure:**
- Create `wwwroot/avatars/` directory
- Add `.gitignore` entry for `wwwroot/avatars/*` (don't commit user uploads)

### Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Large avatar uploads (>10MB)** | Medium | Enforce 2MB limit; validate before upload |
| **Migration breaks existing users** | High | All new fields nullable; test with existing data |
| **GDPR concerns (emergency contact)** | Medium | Add consent checkbox; document data usage |
| **Skill/certification JSON becomes complex** | Low | Future: migrate to Certifications table |
| **Audit log grows unbounded** | Medium | Add archival job (90 days retention) |
| **Employee edits manager-only fields** | High | Strict permission checks in service layer |
| **Special characters in file names** | Low | Sanitize filenames; use userId.jpg format |

---

## Feature 3: Shift Reminder Notifications

**Estimated Effort:** 16-24 hours
**Priority:** Medium
**Dependencies:** Hangfire or Quartz.NET (background job scheduler)

### Task List

- [ ] **3.1 Setup Background Job Infrastructure**
  - [ ] Research: Hangfire vs Quartz.NET (recommendation: Hangfire for simplicity)
  - [ ] Add Hangfire NuGet package
  - [ ] Configure Hangfire in Program.cs (SQLite storage)
  - [ ] Create `/hangfire` dashboard route (admin only)

- [ ] **3.2 Create Reminder Service**
  - [ ] Create `Services/IReminderService.cs` interface
  - [ ] Create `Services/ReminderService.cs` implementation
  - [ ] Method: `Task SendShiftRemindersAsync(int hoursBeforeShift)`
  - [ ] Method: `Task<List<ShiftAssignment>> GetUpcomingShiftsAsync(DateTime startWindow, DateTime endWindow)`

- [ ] **3.3 Implement Reminder Logic**
  - [ ] Query shifts starting in X hours (6h window, 2h window)
  - [ ] Filter: Only send if user is active and shift not canceled
  - [ ] Check: Don't send duplicate reminders (track sent reminders)
  - [ ] Create notification: `NotificationType.ShiftReminder` (new enum value)
  - [ ] Include: Shift type, date, start time, location/notes

- [ ] **3.4 Create Reminder Tracking Table**
  - [ ] Create `Models/ShiftReminder.cs` (track sent reminders to avoid duplicates)
  - [ ] Fields: ShiftAssignmentId, ReminderType (6Hour, 2Hour), SentAt
  - [ ] Unique index on (ShiftAssignmentId, ReminderType)

- [ ] **3.5 Schedule Background Jobs**
  - [ ] Job 1: Run every 30 minutes → Send 6-hour reminders
  - [ ] Job 2: Run every 15 minutes → Send 2-hour reminders
  - [ ] Hangfire dashboard: `/hangfire` (admin access only)

- [ ] **3.6 Implement Smart Rules**
  - [ ] Suppress if shift is canceled (ShiftAssignment deleted)
  - [ ] Suppress if user has time-off approved for that date
  - [ ] Timezone-aware: calculate "X hours before" in user's timezone
  - [ ] Do Not Disturb: Mark as "silent" notification (no sound, just badge)

- [ ] **3.7 Add User Preferences**
  - [ ] Extend AppUser with: `ReminderPreference` (Off, 6HourOnly, 2HourOnly, Both)
  - [ ] Default: Both (6h and 2h reminders)
  - [ ] Add UI to My/Profile → "Notification Preferences"

- [ ] **3.8 Update Notification Center**
  - [ ] Add `NotificationType.ShiftReminder6Hour` (enum value 12)
  - [ ] Add `NotificationType.ShiftReminder2Hour` (enum value 13)
  - [ ] Update notification icons (clock icon for reminders)

- [ ] **3.9 Testing**
  - [ ] Unit test: reminder service returns correct shifts
  - [ ] Unit test: no duplicate reminders sent
  - [ ] Integration test: create shift 5 hours from now → verify 6h reminder NOT sent
  - [ ] Integration test: create shift 7 hours from now → verify 6h reminder sent
  - [ ] Test timezone edge cases (shift crosses midnight)
  - [ ] Test Do Not Disturb preference

### Technical Design

**Data Model Changes:**

```csharp
// New table: track sent reminders
public class ShiftReminder : IBelongsToCompany
{
    public int Id { get; set; }
    public int CompanyId { get; set; }
    public int ShiftAssignmentId { get; set; }
    public ShiftAssignment ShiftAssignment { get; set; } = null!;
    public ReminderType Type { get; set; }  // 6Hour, 2Hour
    public DateTime SentAt { get; set; } = DateTime.UtcNow;
}

public enum ReminderType
{
    SixHour = 0,
    TwoHour = 1
}

// Extend AppUser
public class AppUser
{
    // ... existing fields ...
    public ReminderPreference ReminderPreference { get; set; } = ReminderPreference.Both;
}

public enum ReminderPreference
{
    Off = 0,
    SixHourOnly = 1,
    TwoHourOnly = 2,
    Both = 3
}

// Extend NotificationType enum
public enum NotificationType
{
    // ... existing values 0-11 ...
    ShiftReminder6Hour = 12,
    ShiftReminder2Hour = 13
}
```

**Migration:**
```bash
dotnet ef migrations add AddShiftReminders
```

**New Services:**
```csharp
public interface IReminderService
{
    Task SendShiftRemindersAsync(int hoursBeforeShift);
    Task<List<ShiftAssignment>> GetUpcomingShiftsAsync(DateTime startWindow, DateTime endWindow);
}
```

**Background Jobs (Hangfire):**
```csharp
// Program.cs configuration
RecurringJob.AddOrUpdate<IReminderService>(
    "send-6hour-reminders",
    service => service.SendShiftRemindersAsync(6),
    "*/30 * * * *"); // Every 30 minutes

RecurringJob.AddOrUpdate<IReminderService>(
    "send-2hour-reminders",
    service => service.SendShiftRemindersAsync(2),
    "*/15 * * * *"); // Every 15 minutes
```

**Authorization:**
- `/hangfire` dashboard → `[Authorize(Policy="IsAdmin")]`
- Reminder jobs run as system (no user context)

**Notifications:**
- Title: "Shift Reminder"
- Message: "Your {ShiftTypeName} shift starts in {X} hours on {Date} at {StartTime}."
- Type: `ShiftReminder6Hour` or `ShiftReminder2Hour`
- RelatedEntityId: `ShiftAssignmentId`
- RelatedEntityType: `"ShiftAssignment"`

### Dependencies

**NuGet Packages:**
- **Hangfire.Core** (v1.8.6)
- **Hangfire.AspNetCore** (v1.8.6)
- **Hangfire.Storage.SQLite** (v0.4.2) - Use SQLite for job storage
  ```bash
  dotnet add package Hangfire.Core
  dotnet add package Hangfire.AspNetCore
  dotnet add package Hangfire.Storage.SQLite
  ```

**Infrastructure:**
- Hangfire creates tables in SQLite: `HangfireJob`, `HangfireState`, etc.
- Dashboard accessible at `/hangfire` (admin only)

### Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Hangfire jobs fail silently** | High | Add logging; monitor dashboard; set retry policy |
| **Duplicate reminders if job runs twice** | Medium | Track sent reminders in `ShiftReminder` table |
| **Timezone bugs (user in different timezone)** | High | Store all times in UTC; convert to user timezone for display |
| **Shift deleted but reminder still queued** | Low | Check `ShiftAssignment` exists before sending |
| **Too many reminders spam users** | Low | Add preference UI; allow disabling |
| **Hangfire adds 10+ tables to database** | Low | Acceptable; use same SQLite database |
| **Background jobs crash app** | Medium | Hangfire has retry mechanism; add try-catch in service |

---

## Feature 4: Announcements Feed

**Estimated Effort:** 24-32 hours
**Priority:** Medium
**Dependencies:** File upload (attachments), notification system

### Task List

- [ ] **4.1 Database Schema**
  - [ ] Create `Models/Announcement.cs` model
  - [ ] Create `Models/AnnouncementAcknowledgement.cs` model
  - [ ] Create `Models/AnnouncementPriority.cs` enum (Normal, High, Urgent)
  - [ ] Create migration `AddAnnouncementsFeed`
  - [ ] Test migration

- [ ] **4.2 Create Announcement Service**
  - [ ] Create `Services/IAnnouncementService.cs` interface
  - [ ] Create `Services/AnnouncementService.cs` implementation
  - [ ] Method: `Task<Announcement> CreateAnnouncementAsync(CreateAnnouncementDto dto, int publisherId)`
  - [ ] Method: `Task<List<Announcement>> GetActiveAnnouncementsAsync(int userId)`
  - [ ] Method: `Task AcknowledgeAnnouncementAsync(int announcementId, int userId)`
  - [ ] Method: `Task<AnnouncementStats> GetAnnouncementStatsAsync(int announcementId)`

- [ ] **4.3 Implement Targeting Logic**
  - [ ] Target by CompanyId (Directors choose which companies)
  - [ ] Owners can target "All Companies" (CompanyId = null)
  - [ ] Validate publisher permissions (managers → own company only)

- [ ] **4.4 Build Announcements Feed UI**
  - [ ] Create `Pages/Announcements/Index.cshtml` (employee view)
  - [ ] Display active announcements (not expired)
  - [ ] Priority badges: 🔴 Urgent, 🟡 High, ⚪ Normal
  - [ ] "Acknowledge" button (marks as read)
  - [ ] Show: Title, message, published date, publisher name
  - [ ] Attachments: download links

- [ ] **4.5 Build Announcement Creation UI**
  - [ ] Create `Pages/Admin/Announcements.cshtml` (manager/director/owner only)
  - [ ] Form: Title, Message (rich text editor or plain textarea), Priority, Expiry Date
  - [ ] File upload: PDF/images (max 5MB, max 3 files)
  - [ ] Target selection (Directors: choose companies; Owners: "All" option)

- [ ] **4.6 Implement Attachment Handling**
  - [ ] Create `wwwroot/announcements/` directory
  - [ ] Save files as `{announcementId}_{filename}`
  - [ ] Validate file types: PDF, PNG, JPG, JPEG, WEBP
  - [ ] Store paths in `AttachmentsJson` field (JSON array)

- [ ] **4.7 Add Acknowledgement Tracking**
  - [ ] Display "X of Y employees acknowledged" on admin view
  - [ ] Manager can see who acknowledged (list view)
  - [ ] Send reminder notification if not acknowledged after 24h (optional)

- [ ] **4.8 Integrate with Notification System**
  - [ ] Create notification on announcement publish
  - [ ] Type: `NotificationType.AnnouncementPublished` (new enum value 14)
  - [ ] Link to announcement in notification center
  - [ ] Badge count includes unacknowledged announcements

- [ ] **4.9 Add Expiry & Archival**
  - [ ] Daily background job: mark expired announcements as inactive
  - [ ] Expired announcements hidden from feed
  - [ ] Admin can view archived announcements (last 30 days)

- [ ] **4.10 Testing**
  - [ ] Unit test: Manager can only target own company
  - [ ] Unit test: Director can target multiple companies
  - [ ] Unit test: Owner can target all companies
  - [ ] Test acknowledgement tracking (view count)
  - [ ] Test file upload (valid/invalid types)
  - [ ] Test expiry logic (announcement becomes inactive)

### Technical Design

**Data Model Changes:**

```csharp
public class Announcement : IBelongsToCompany
{
    public int Id { get; set; }
    public int? CompanyId { get; set; }  // Nullable: null = all companies (Owner only)
    public int PublisherId { get; set; }
    public AppUser Publisher { get; set; } = null!;

    [Required]
    [StringLength(200)]
    public string Title { get; set; } = "";

    [Required]
    [StringLength(5000)]
    public string Message { get; set; } = "";

    public AnnouncementPriority Priority { get; set; } = AnnouncementPriority.Normal;

    public DateTime PublishedAt { get; set; } = DateTime.UtcNow;

    public DateTime? ExpiryDate { get; set; }  // Nullable: no expiry

    public bool IsActive { get; set; } = true;

    // JSON array of file paths: ["/announcements/1_file.pdf", ...]
    public string? AttachmentsJson { get; set; }

    // For multi-company targeting (Directors)
    // JSON array of CompanyIds: [1, 2, 3] (empty = own company only)
    public string? TargetCompanyIdsJson { get; set; }
}

public class AnnouncementAcknowledgement : IBelongsToCompany
{
    public int Id { get; set; }
    public int CompanyId { get; set; }
    public int AnnouncementId { get; set; }
    public Announcement Announcement { get; set; } = null!;
    public int UserId { get; set; }
    public AppUser User { get; set; } = null!;
    public DateTime AcknowledgedAt { get; set; } = DateTime.UtcNow;
}

public enum AnnouncementPriority
{
    Normal = 0,
    High = 1,
    Urgent = 2
}

// Extend NotificationType
public enum NotificationType
{
    // ... existing 0-13 ...
    AnnouncementPublished = 14
}
```

**Migration:**
```bash
dotnet ef migrations add AddAnnouncementsFeed
```

**Indexes:**
```csharp
// AppDbContext.OnModelCreating
modelBuilder.Entity<Announcement>()
    .HasIndex(a => new { a.CompanyId, a.IsActive, a.PublishedAt });

modelBuilder.Entity<AnnouncementAcknowledgement>()
    .HasIndex(aa => new { aa.AnnouncementId, aa.UserId })
    .IsUnique();  // One acknowledgement per user
```

**New Services:**
```csharp
public interface IAnnouncementService
{
    Task<Announcement> CreateAnnouncementAsync(CreateAnnouncementDto dto, int publisherId);
    Task<List<Announcement>> GetActiveAnnouncementsAsync(int userId);
    Task AcknowledgeAnnouncementAsync(int announcementId, int userId);
    Task<AnnouncementStats> GetAnnouncementStatsAsync(int announcementId);
    Task ExpireOldAnnouncementsAsync();  // Background job
}

public class CreateAnnouncementDto
{
    public string Title { get; set; } = "";
    public string Message { get; set; } = "";
    public AnnouncementPriority Priority { get; set; }
    public DateTime? ExpiryDate { get; set; }
    public List<int>? TargetCompanyIds { get; set; }  // Directors only
    public List<IFormFile>? Attachments { get; set; }
}

public class AnnouncementStats
{
    public int TotalTargetedEmployees { get; set; }
    public int AcknowledgedCount { get; set; }
    public List<AppUser> AcknowledgedUsers { get; set; } = new();
    public List<AppUser> NotAcknowledgedUsers { get; set; } = new();
}
```

**New Pages:**
- `Pages/Announcements/Index.cshtml` → Employee view (all roles)
- `Pages/Admin/Announcements.cshtml` → Create/manage (managers+)

**Authorization:**
- `Announcements/Index` → Authenticated (all users)
- `Admin/Announcements` → IsManagerOrAdmin
- Validation: Managers can only create for own CompanyId
- Validation: Directors can only target companies they manage
- Validation: Owners can target any/all companies

**Background Jobs (Hangfire):**
```csharp
RecurringJob.AddOrUpdate<IAnnouncementService>(
    "expire-announcements",
    service => service.ExpireOldAnnouncementsAsync(),
    Cron.Daily(2)); // Daily at 2 AM
```

**Notifications:**
- When announcement published → Notify all targeted employees
- Type: `AnnouncementPublished`
- Title: announcement title
- Message: first 100 chars of announcement message
- RelatedEntityId: `AnnouncementId`

### Dependencies

**NuGet Packages:** None (uses existing file upload infrastructure)

**Infrastructure:**
- Create `wwwroot/announcements/` directory
- Add `.gitignore` entry for `wwwroot/announcements/*`

### Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Manager creates announcement for wrong company** | High | Strict validation in service layer |
| **Large file uploads (>50MB)** | Medium | Enforce 5MB per file, max 3 files |
| **Expired announcements not hidden** | Low | Daily background job; add index on IsActive |
| **Director targets company they don't manage** | High | Validate against DirectorCompanies table |
| **Notification spam (100+ employees)** | Medium | Batch notification creation (100 at a time) |
| **Attachments never deleted** | Low | Add cleanup job (delete after 90 days post-expiry) |
| **Rich text editor XSS vulnerability** | High | Sanitize HTML or use plain text only |

**Recommendation:** Use plain textarea (no rich text) to avoid XSS risks. Users can format with Markdown if needed (future enhancement).

---

## Feature 5: Shift Analytics & Reporting

**Estimated Effort:** 32-48 hours
**Priority:** High
**Dependencies:** Export service (Feature 1), chart library (optional)

### Task List

- [ ] **5.1 Create Analytics Service**
  - [ ] Create `Services/IAnalyticsService.cs` interface
  - [ ] Create `Services/AnalyticsService.cs` implementation
  - [ ] Method: `Task<EmployeeAnalytics> GetEmployeeAnalyticsAsync(int userId, DateRange range)`
  - [ ] Method: `Task<TeamAnalytics> GetTeamAnalyticsAsync(DateRange range, int? departmentId)`
  - [ ] Method: `Task<SwapAnalytics> GetSwapAnalyticsAsync(DateRange range, int? departmentId)`
  - [ ] Method: `Task<TimeOffAnalytics> GetTimeOffAnalyticsAsync(DateRange range, int? departmentId)`
  - [ ] Method: `Task<BackToBackShiftReport> GetBackToBackShiftsAsync(DateRange range)`

- [ ] **5.2 Define Analytics Models**
  - [ ] Create `Models/Analytics/EmployeeAnalytics.cs` (hours worked, shifts, swaps, etc.)
  - [ ] Create `Models/Analytics/TeamAnalytics.cs` (by department, role, date range)
  - [ ] Create `Models/Analytics/SwapAnalytics.cs` (swap rate, top swappers)
  - [ ] Create `Models/Analytics/TimeOffAnalytics.cs` (requests, approvals, balances)
  - [ ] Create `Models/Analytics/BackToBackShiftReport.cs` (consecutive shifts with <8h rest)
  - [ ] Create `Models/Analytics/DateRange.cs` helper

- [ ] **5.3 Implement Employee Analytics (My Shifts)**
  - [ ] Hours worked (week/month aggregation)
  - [ ] Upcoming workload (next 7/14/30 days)
  - [ ] Time-off requests (pending/approved/declined counts)
  - [ ] Swaps participated in (as requester or target)
  - [ ] Most common shift types
  - [ ] Back-to-back shift count (flag if >2 per week)

- [ ] **5.4 Implement Team Analytics**
  - [ ] Hours worked report: by employee, department, role, date range
  - [ ] Export to CSV/Excel (reuse Feature 1 ExportService)
  - [ ] Average shifts per employee (by department/company, time window)
  - [ ] Understaffing report (shifts with Assigned < Required)
  - [ ] Overstaffing report (shifts with Assigned > Required)

- [ ] **5.5 Implement Swap Analytics**
  - [ ] Total swaps by employee/department (count, rate)
  - [ ] Swap rate over time (chart: swaps per week)
  - [ ] Top swappers (employees with most swap requests)
  - [ ] Swap approval rate (approved / total requested)

- [ ] **5.6 Implement Time-Off Analytics**
  - [ ] Requests by status (pending/approved/declined counts)
  - [ ] Time-off balances by employee (future: requires PTO balance tracking)
  - [ ] Average approval time (days from request to decision)
  - [ ] Time-off impact: days with understaffing due to approved time-off

- [ ] **5.7 Implement Back-to-Back Shift Detection**
  - [ ] Define: Two consecutive shifts with <8 hours rest between end and next start
  - [ ] Query: Find all shift pairs where (Shift2.Start - Shift1.End) < 8 hours
  - [ ] Report: Employee, Date, Shift1 (type, times), Shift2 (type, times), Rest Hours
  - [ ] Count: Total back-to-back shifts per employee/department
  - [ ] Rate: % of shifts that are back-to-back

- [ ] **5.8 Build Analytics UI**
  - [ ] Create `Pages/My/Analytics.cshtml` (employee personal analytics)
  - [ ] Create `Pages/Admin/Analytics.cshtml` (manager/director team analytics)
  - [ ] Date range picker (last 7 days, 30 days, 90 days, custom)
  - [ ] Department/role filters (managers+)
  - [ ] Export buttons (CSV, Excel, PDF)

- [ ] **5.9 Add Charts (Optional)**
  - [ ] Use Chart.js or Recharts (client-side rendering)
  - [ ] Hours worked over time (line chart)
  - [ ] Swaps over time (bar chart)
  - [ ] Back-to-back shifts trend (line chart)

- [ ] **5.10 Testing**
  - [ ] Unit test: Hours worked calculation (include overnight shifts)
  - [ ] Unit test: Back-to-back shift detection (various scenarios)
  - [ ] Unit test: Swap rate calculation
  - [ ] Integration test: Employee analytics matches actual data
  - [ ] Performance test: Team analytics with 100+ employees, 1 year data

### Technical Design

**Data Model Changes:** None (uses existing tables: ShiftAssignment, SwapRequest, TimeOffRequest)

**New Services:**
```csharp
public interface IAnalyticsService
{
    Task<EmployeeAnalytics> GetEmployeeAnalyticsAsync(int userId, DateRange range);
    Task<TeamAnalytics> GetTeamAnalyticsAsync(DateRange range, int? departmentId = null);
    Task<SwapAnalytics> GetSwapAnalyticsAsync(DateRange range, int? departmentId = null);
    Task<TimeOffAnalytics> GetTimeOffAnalyticsAsync(DateRange range, int? departmentId = null);
    Task<BackToBackShiftReport> GetBackToBackShiftsAsync(DateRange range, int? departmentId = null);
}

public class EmployeeAnalytics
{
    public int TotalHoursWorked { get; set; }
    public int TotalShiftsWorked { get; set; }
    public int UpcomingShifts7Days { get; set; }
    public int UpcomingShifts30Days { get; set; }
    public int TimeOffRequestsPending { get; set; }
    public int TimeOffRequestsApproved { get; set; }
    public int SwapsRequested { get; set; }
    public int SwapsReceived { get; set; }
    public Dictionary<string, int> ShiftTypeBreakdown { get; set; } = new();  // "MORNING": 15
    public int BackToBackShiftCount { get; set; }
}

public class TeamAnalytics
{
    public List<EmployeeHoursRow> EmployeeHours { get; set; } = new();
    public double AverageShiftsPerEmployee { get; set; }
    public int TotalShifts { get; set; }
    public int TotalHours { get; set; }
    public List<ShiftInstanceRow> UnderstaffedShifts { get; set; } = new();
    public List<ShiftInstanceRow> OverstaffedShifts { get; set; } = new();
}

public class EmployeeHoursRow
{
    public int UserId { get; set; }
    public string EmployeeName { get; set; } = "";
    public string Department { get; set; } = "";
    public UserRole Role { get; set; }
    public int TotalHours { get; set; }
    public int TotalShifts { get; set; }
}

public class SwapAnalytics
{
    public int TotalSwapRequests { get; set; }
    public int ApprovedSwaps { get; set; }
    public int DeclinedSwaps { get; set; }
    public double ApprovalRate { get; set; }  // %
    public List<EmployeeSwapRow> TopSwappers { get; set; } = new();
    public Dictionary<string, int> SwapsByWeek { get; set; } = new();  // "2025-W41": 5
}

public class EmployeeSwapRow
{
    public int UserId { get; set; }
    public string EmployeeName { get; set; } = "";
    public int SwapRequestCount { get; set; }
}

public class TimeOffAnalytics
{
    public int TotalRequests { get; set; }
    public int PendingRequests { get; set; }
    public int ApprovedRequests { get; set; }
    public int DeclinedRequests { get; set; }
    public double AverageApprovalTimeDays { get; set; }
    public List<TimeOffRequestRow> RequestsByEmployee { get; set; } = new();
}

public class BackToBackShiftReport
{
    public List<BackToBackShiftRow> BackToBackShifts { get; set; } = new();
    public Dictionary<int, int> CountByEmployee { get; set; } = new();  // UserId: count
    public int TotalBackToBackShifts { get; set; }
}

public class BackToBackShiftRow
{
    public int UserId { get; set; }
    public string EmployeeName { get; set; } = "";
    public DateOnly Date { get; set; }
    public string Shift1Type { get; set; } = "";
    public TimeOnly Shift1End { get; set; }
    public string Shift2Type { get; set; } = "";
    public TimeOnly Shift2Start { get; set; }
    public double RestHours { get; set; }  // Hours between shifts
}

public class DateRange
{
    public DateOnly Start { get; set; }
    public DateOnly End { get; set; }

    public static DateRange Last7Days() => new() {
        Start = DateOnly.FromDateTime(DateTime.Today.AddDays(-7)),
        End = DateOnly.FromDateTime(DateTime.Today)
    };
    public static DateRange Last30Days() => new() {
        Start = DateOnly.FromDateTime(DateTime.Today.AddDays(-30)),
        End = DateOnly.FromDateTime(DateTime.Today)
    };
}
```

**Back-to-Back Shift Query Logic:**
```csharp
// Find consecutive shifts with <8 hours rest
var backToBackShifts = await _db.ShiftAssignments
    .Include(sa => sa.ShiftInstance)
    .ThenInclude(si => si.ShiftType)
    .Where(sa => sa.UserId == userId && sa.ShiftInstance.WorkDate >= startDate && sa.ShiftInstance.WorkDate <= endDate)
    .OrderBy(sa => sa.ShiftInstance.WorkDate)
    .ThenBy(sa => sa.ShiftInstance.ShiftType.Start)
    .ToListAsync();

var backToBackPairs = new List<BackToBackShiftRow>();
for (int i = 0; i < backToBackShifts.Count - 1; i++)
{
    var shift1 = backToBackShifts[i];
    var shift2 = backToBackShifts[i + 1];

    var shift1End = shift1.ShiftInstance.WorkDate.ToDateTime(shift1.ShiftInstance.ShiftType.End);
    var shift2Start = shift2.ShiftInstance.WorkDate.ToDateTime(shift2.ShiftInstance.ShiftType.Start);

    var restHours = (shift2Start - shift1End).TotalHours;

    if (restHours < 8 && restHours >= 0)  // 0 to 8 hours rest
    {
        backToBackPairs.Add(new BackToBackShiftRow
        {
            UserId = userId,
            EmployeeName = shift1.User.DisplayName,
            Date = shift1.ShiftInstance.WorkDate,
            Shift1Type = shift1.ShiftInstance.ShiftType.Key,
            Shift1End = shift1.ShiftInstance.ShiftType.End,
            Shift2Type = shift2.ShiftInstance.ShiftType.Key,
            Shift2Start = shift2.ShiftInstance.ShiftType.Start,
            RestHours = restHours
        });
    }
}
```

**New Pages:**
- `Pages/My/Analytics.cshtml` → Employee personal analytics
- `Pages/Admin/Analytics.cshtml` → Manager/director team analytics

**Authorization:**
- `My/Analytics` → Authenticated (employee sees own data)
- `Admin/Analytics` → IsManagerOrAdmin (team-wide analytics)

**Background Jobs:** None (analytics computed on-demand)

**Notifications:** None

### Dependencies

**NuGet Packages:**
- Reuse `ClosedXML` from Feature 1 for CSV/Excel export
- **Optional:** Chart.js (client-side JavaScript library, no NuGet package needed)

**Infrastructure:** None

### Risks & Mitigations

| Risk | Impact | Mitigation |
|------|--------|------------|
| **Slow queries with large datasets (1+ year)** | High | Add indexes; paginate results; cache frequently accessed reports |
| **Back-to-back logic fails for overnight shifts** | Medium | Careful date/time math; handle midnight crossover |
| **Hours calculation incorrect (overtime shifts)** | Medium | Use (ShiftType.End - ShiftType.Start) duration |
| **Department filter doesn't work (no Department FK yet)** | Low | Use string comparison on AppUser.Department (nullable) |
| **Export crashes with 1000+ employees** | Medium | Stream to file; limit to 500 rows or paginate |
| **Swap analytics include deleted swaps** | Low | Filter by active swaps only |

---

## Git Branching Strategy

### Branch Structure

```
main (protected)
  ├── feature/export-schedules
  ├── feature/employee-profiles
  ├── feature/shift-reminders
  ├── feature/announcements
  └── feature/shift-analytics
```

### Branching Rules

1. **Main Branch Protection:**
   - `main` is protected (no direct commits)
   - Requires PR approval before merge
   - All tests must pass before merge

2. **Feature Branches:**
   - Create one branch per feature (short-lived, 3-5 days max)
   - Branch naming: `feature/<feature-name>` (e.g., `feature/export-schedules`)
   - Merge to `main` via Pull Request (PR)
   - Delete feature branch after merge

3. **Commit Strategy:**
   - **Atomic commits:** Each commit should be a working state (compilable, tests pass)
   - Commit message format:
     ```
     [Feature] Short description

     - Detailed bullet point 1
     - Detailed bullet point 2

     Resolves: #123 (optional issue link)
     ```
   - Examples:
     - `[Export] Add ExportService with Excel generation`
     - `[Profiles] Add avatar upload with validation`
     - `[Reminders] Implement Hangfire job scheduler`

4. **Migration Strategy:**
   - **One migration per feature branch**
   - Migration naming: `Add{FeatureName}` (e.g., `AddEmployeeProfileEnhancements`)
   - Test migration: `dotnet ef database drop && dotnet ef database update`
   - Never modify existing migrations (always create new ones)

5. **PR Review Checklist:**
   - [ ] All tests pass
   - [ ] Migration tested (up/down/up)
   - [ ] No hardcoded values or secrets
   - [ ] Authorization checks in place
   - [ ] Localization strings added (en-US, he-IL)
   - [ ] Documentation updated (if needed)

### Merge Order (Recommended)

Merge features in dependency order to avoid conflicts:

1. **Week 1 (Days 1-2):** `feature/export-schedules` → `main`
2. **Week 1 (Days 3-4):** `feature/employee-profiles` → `main`
3. **Week 2 (Days 1-2):** `feature/shift-reminders` → `main` (depends on Hangfire setup)
4. **Week 2 (Days 3-4):** `feature/announcements` → `main` (depends on file upload from profiles)
5. **Week 3 (Days 1-3):** `feature/shift-analytics` → `main` (depends on export service)

**Rationale:**
- Export service (Feature 1) is a dependency for analytics (Feature 5)
- Profiles (Feature 2) establishes file upload patterns used by announcements (Feature 4)
- Reminders (Feature 3) can be developed in parallel
- Analytics (Feature 5) is largest and goes last

### Conflict Resolution

If merge conflicts occur:
1. Pull latest `main` into feature branch: `git pull origin main`
2. Resolve conflicts locally
3. Run all tests: `dotnet test`
4. Push resolved branch
5. Re-request PR review

---

## Implementation Timeline

### Week 1: Export & Profiles (Oct 13-17, 2025)

| Day | Feature | Tasks | Hours |
|-----|---------|-------|-------|
| **Mon** | Export Schedules | 1.1-1.3: Setup, models, service interface | 6h |
| **Tue** | Export Schedules | 1.4-1.5: Excel + PDF implementation | 8h |
| **Wed** | Export Schedules | 1.6-1.9: UI, authorization, testing | 6h |
| **Wed PM** | Employee Profiles | 2.1-2.2: Schema, migration, service setup | 4h |
| **Thu** | Employee Profiles | 2.3-2.5: Avatar upload, UI, permissions | 8h |
| **Fri** | Employee Profiles | 2.6-2.9: Profile drawer, audit log, testing | 8h |

**Deliverables:**
- ✅ Export schedules to Excel/PDF (managers+)
- ✅ Employee self-service for schedule export
- ✅ Enhanced employee profiles (10+ new fields)
- ✅ Avatar upload with validation
- ✅ Profile audit log

---

### Week 2: Reminders & Announcements (Oct 20-24, 2025)

| Day | Feature | Tasks | Hours |
|-----|---------|-------|-------|
| **Mon** | Shift Reminders | 3.1-3.3: Hangfire setup, reminder service, logic | 8h |
| **Tue** | Shift Reminders | 3.4-3.6: Tracking table, jobs, smart rules | 6h |
| **Tue PM** | Shift Reminders | 3.7-3.9: User prefs, notification center, testing | 4h |
| **Wed** | Announcements | 4.1-4.3: Schema, service, targeting logic | 8h |
| **Thu** | Announcements | 4.4-4.6: Feed UI, creation UI, attachments | 8h |
| **Fri** | Announcements | 4.7-4.10: Acknowledgements, expiry, testing | 8h |

**Deliverables:**
- ✅ Automated shift reminders (6h and 2h before)
- ✅ Hangfire background job infrastructure
- ✅ Announcements feed (top-down communication)
- ✅ Attachment support (PDF/images)
- ✅ Acknowledgement tracking

---

### Week 3: Analytics & Integration (Oct 27-31, 2025)

| Day | Feature | Tasks | Hours |
|-----|---------|-------|-------|
| **Mon** | Shift Analytics | 5.1-5.2: Analytics service, models | 6h |
| **Tue** | Shift Analytics | 5.3-5.5: Employee analytics, team analytics, swap analytics | 10h |
| **Wed** | Shift Analytics | 5.6-5.7: Time-off analytics, back-to-back detection | 8h |
| **Thu** | Shift Analytics | 5.8-5.9: UI, charts (optional) | 8h |
| **Fri** | Shift Analytics | 5.10: Testing, bug fixes, integration testing | 8h |

**Deliverables:**
- ✅ Employee personal analytics dashboard
- ✅ Manager team analytics (hours, swaps, time-offs)
- ✅ Back-to-back shift detection and reporting
- ✅ CSV/Excel export for all reports

---

### Week 4: Buffer & Polish (Nov 3-7, 2025)

| Day | Tasks | Hours |
|-----|-------|-------|
| **Mon-Tue** | Bug fixes from testing | 12h |
| **Wed** | Performance optimization (query tuning, indexes) | 6h |
| **Thu** | Localization (translate new strings to Hebrew) | 4h |
| **Fri** | Documentation, deployment prep | 4h |

**Deliverables:**
- ✅ All 5 features tested and stable
- ✅ Localization complete (en-US, he-IL)
- ✅ Performance benchmarks met
- ✅ Documentation updated

---

## Testing Strategy

### Unit Tests

**Coverage Target:** 80% for new services

**Test Files to Create:**
- `ShiftManager.Tests/Services/ExportServiceTests.cs` (20 tests)
- `ShiftManager.Tests/Services/ProfileServiceTests.cs` (25 tests)
- `ShiftManager.Tests/Services/ReminderServiceTests.cs` (15 tests)
- `ShiftManager.Tests/Services/AnnouncementServiceTests.cs` (20 tests)
- `ShiftManager.Tests/Services/AnalyticsServiceTests.cs` (30 tests)

**Total New Tests:** ~110 unit tests

### Integration Tests

**Test Scenarios:**
1. **Export:** Manager exports month schedule, employee exports own schedule
2. **Profiles:** Employee edits phone number, manager edits all fields
3. **Reminders:** Shift created 5 hours from now → no 6h reminder sent
4. **Announcements:** Director creates announcement targeting 2 companies
5. **Analytics:** Back-to-back shift detection with overnight shifts

**Test Files:**
- `ShiftManager.Tests/IntegrationTests/ExportIntegrationTests.cs`
- `ShiftManager.Tests/IntegrationTests/ProfileIntegrationTests.cs`
- `ShiftManager.Tests/IntegrationTests/ReminderIntegrationTests.cs`
- `ShiftManager.Tests/IntegrationTests/AnnouncementIntegrationTests.cs`
- `ShiftManager.Tests/IntegrationTests/AnalyticsIntegrationTests.cs`

**Total New Integration Tests:** ~25 tests

### Manual Testing Checklist

Before merging each feature to `main`:

- [ ] **Export:**
  - [ ] Export month as Excel (verify formatting)
  - [ ] Export week as PDF (verify page breaks)
  - [ ] Employee exports own schedule (verify userId validation)
  - [ ] Export with special characters in names (Unicode test)

- [ ] **Profiles:**
  - [ ] Upload avatar (PNG, JPG, invalid format)
  - [ ] Employee edits phone → success; employee edits role → blocked
  - [ ] Manager edits employee profile → audit log created
  - [ ] Click employee name on calendar → profile drawer opens

- [ ] **Reminders:**
  - [ ] Create shift 5 hours from now → wait 1 hour → verify NO reminder
  - [ ] Create shift 7 hours from now → verify 6h reminder sent
  - [ ] Check Hangfire dashboard → verify jobs running
  - [ ] Test timezone edge case (shift at midnight)

- [ ] **Announcements:**
  - [ ] Manager creates announcement → verify own company only
  - [ ] Director creates announcement → select 2 companies → verify both companies notified
  - [ ] Employee acknowledges announcement → verify stats update
  - [ ] Upload PDF attachment → verify download link works

- [ ] **Analytics:**
  - [ ] View My Analytics → verify hours match calendar
  - [ ] Manager views team analytics → verify totals
  - [ ] Export analytics to Excel → verify formatting
  - [ ] Back-to-back shift report → verify rest hours calculation

### Performance Testing

**Benchmarks:**

| Feature | Scenario | Target | Measurement |
|---------|----------|--------|-------------|
| Export | 1 month, 100 shifts | <5 seconds | Response time |
| Profiles | Load profile page | <500ms | Page load time |
| Reminders | Process 1000 shifts | <30 seconds | Job execution time |
| Announcements | Notify 500 employees | <10 seconds | Notification creation time |
| Analytics | Team analytics, 1 year data | <3 seconds | Query execution time |

**Performance Test Script:**
```bash
# Use Apache Bench (ab) or k6 for load testing
ab -n 100 -c 10 https://localhost:5001/Exports/Excel?start=2025-01-01&end=2025-12-31
```

---

## Deployment Checklist

### Pre-Deployment

- [ ] All tests pass (110+ unit tests, 25+ integration tests)
- [ ] Performance benchmarks met
- [ ] Localization complete (en-US, he-IL)
- [ ] Migration tested on staging database
- [ ] Security review (authorization checks, input validation)
- [ ] Dependency licenses verified (ClosedXML, QuestPDF, Hangfire, ImageSharp)

### Deployment Steps

1. **Backup Production Database**
   ```bash
   cp app.db app.db.backup.$(date +%Y%m%d)
   ```

2. **Pull Latest Code**
   ```bash
   git checkout main
   git pull origin main
   ```

3. **Restore Dependencies**
   ```bash
   dotnet restore
   ```

4. **Build Project**
   ```bash
   dotnet build --configuration Release
   ```

5. **Apply Migrations**
   ```bash
   dotnet ef database update
   ```
   **Expected migrations:**
   - `AddEmployeeProfileEnhancements`
   - `AddShiftReminders`
   - `AddAnnouncementsFeed`

6. **Create Required Directories**
   ```bash
   mkdir -p wwwroot/avatars
   mkdir -p wwwroot/announcements
   ```

7. **Set Permissions (Linux/macOS)**
   ```bash
   chmod 755 wwwroot/avatars
   chmod 755 wwwroot/announcements
   ```

8. **Run Application**
   ```bash
   dotnet run --configuration Release
   ```

9. **Verify Health Check**
   ```bash
   curl https://localhost:5001/health
   # Expected: "Healthy"
   ```

10. **Verify Hangfire Dashboard**
    - Navigate to: `https://localhost:5001/hangfire`
    - Login as Owner
    - Verify jobs: `send-6hour-reminders`, `send-2hour-reminders`, `expire-announcements`

### Post-Deployment

- [ ] Smoke test all 5 features (manual checklist above)
- [ ] Monitor logs for errors (first 24 hours)
- [ ] Check Hangfire job success rate
- [ ] Verify notification counts are reasonable
- [ ] Monitor database size (Hangfire adds ~10MB of tables)

### Rollback Plan

If critical bugs found:

1. **Stop Application**
   ```bash
   # Press Ctrl+C or kill process
   ```

2. **Restore Database Backup**
   ```bash
   cp app.db.backup.20251006 app.db
   ```

3. **Rollback Code**
   ```bash
   git checkout <previous-commit-hash>
   dotnet build
   dotnet run
   ```

4. **Alternative:** Rollback migrations one-by-one
   ```bash
   dotnet ef database update <PreviousMigrationName>
   ```

---

## Dependencies Summary

### NuGet Packages to Add

```xml
<!-- ShiftManager.csproj -->
<PackageReference Include="ClosedXML" Version="0.104.0" />
<PackageReference Include="QuestPDF" Version="2023.12.0" />
<PackageReference Include="SixLabors.ImageSharp" Version="3.0.0" />
<PackageReference Include="Hangfire.Core" Version="1.8.6" />
<PackageReference Include="Hangfire.AspNetCore" Version="1.8.6" />
<PackageReference Include="Hangfire.Storage.SQLite" Version="0.4.2" />
```

**Total Package Cost:**
- **Free (MIT/LGPL):** ClosedXML, SixLabors.ImageSharp, Hangfire
- **Paid (Commercial License):** QuestPDF ($99/year for commercial use)
  - **Alternative:** Use iTextSharp 5.5.13.3 (LGPL, free)

### License Compatibility Check

| Package | License | Commercial Use | Notes |
|---------|---------|----------------|-------|
| ClosedXML | MIT | ✅ Yes | Free for all use |
| QuestPDF | MIT (with commercial restriction) | ⚠️ Paid ($99/year) | Free for non-commercial; community license required |
| SixLabors.ImageSharp | Apache 2.0 | ✅ Yes (with restrictions) | Check Six Labors Commercial License |
| Hangfire | LGPL v3 | ✅ Yes | Free for all use |

**Recommendation:** Verify QuestPDF and ImageSharp licenses for your use case. If commercial restrictions apply, use alternatives:
- **PDF:** iTextSharp 5.5.13.3 (LGPL) or PdfSharpCore (MIT)
- **Image:** System.Drawing (built-in) or SkiaSharp (MIT)

---

## Risks & Mitigations Summary

### High-Risk Items

| Risk | Feature | Impact | Mitigation |
|------|---------|--------|------------|
| **Employee exports other users' data** | Export | Data breach | Strict userId validation in ExportService |
| **Employee edits manager-only fields** | Profiles | Data corruption | Field-level permission checks in ProfileService |
| **Manager creates announcement for wrong company** | Announcements | Multi-tenant leak | Validate CompanyId in AnnouncementService |
| **Timezone bugs cause wrong reminder times** | Reminders | No-shows | Store UTC; convert to user timezone for display |
| **Migration breaks existing users** | Profiles | App crash | All new fields nullable; test with prod data |

### Medium-Risk Items

| Risk | Feature | Impact | Mitigation |
|------|---------|--------|------------|
| **Large exports timeout (>1000 shifts)** | Export | User frustration | Limit to 3 months; add pagination |
| **Hangfire jobs fail silently** | Reminders | No reminders sent | Add logging; monitor dashboard |
| **Duplicate reminders sent** | Reminders | Notification spam | Track sent reminders in ShiftReminder table |
| **Large file uploads (>50MB)** | Announcements | Server crash | Enforce 5MB limit per file |
| **Slow analytics queries** | Analytics | Timeout | Add indexes; paginate results |

### Low-Risk Items

| Risk | Feature | Impact | Mitigation |
|------|---------|--------|------------|
| **Special characters break Excel** | Export | Formatting issues | ClosedXML handles Unicode |
| **Audit log grows unbounded** | Profiles | Database bloat | Add archival job (90 days retention) |
| **Attachments never deleted** | Announcements | Disk space | Cleanup job (delete after 90 days post-expiry) |
| **Back-to-back logic fails for overnight shifts** | Analytics | Incorrect reports | Careful date/time math; test edge cases |

---

## Success Criteria

### Definition of Done (per feature)

A feature is considered "done" when:

1. ✅ All tasks completed (checklist items)
2. ✅ Unit tests pass (80%+ coverage)
3. ✅ Integration tests pass
4. ✅ Manual testing checklist completed
5. ✅ Authorization checks in place (employee/manager/director/owner)
6. ✅ Multi-tenant isolation validated (CompanyId scoping)
7. ✅ Localization strings added (en-US, he-IL)
8. ✅ Migration tested (up/down/up)
9. ✅ Performance benchmark met
10. ✅ Code reviewed and approved (PR)

### Project Success Metrics

**Week 4 Goals:**

- ✅ All 5 features deployed to production
- ✅ 0 critical bugs in first 24 hours
- ✅ <5 medium bugs in first week
- ✅ 110+ unit tests passing
- ✅ 25+ integration tests passing
- ✅ All performance benchmarks met
- ✅ Health check endpoint returns "Healthy"
- ✅ Hangfire jobs running successfully (>95% success rate)

---

## Appendix: Database Migrations

### Expected Migration Files

```
Migrations/
├── 20251013120000_AddEmployeeProfileEnhancements.cs
├── 20251020140000_AddShiftReminders.cs
└── 20251022160000_AddAnnouncementsFeed.cs
```

### Migration Testing Procedure

For each migration:

1. **Test UP (apply migration)**
   ```bash
   dotnet ef database update
   ```

2. **Test DOWN (rollback)**
   ```bash
   dotnet ef database update <PreviousMigrationName>
   ```

3. **Test UP again (re-apply)**
   ```bash
   dotnet ef database update
   ```

4. **Verify data integrity**
   ```bash
   sqlite3 app.db "SELECT COUNT(*) FROM AppUser;"
   sqlite3 app.db "PRAGMA table_info(AppUser);"
   ```

5. **Generate rollback script**
   ```bash
   dotnet ef migrations script <PreviousMigration> <CurrentMigration> \
       --output "Migrations/rollback/<MigrationNumber>_<MigrationName>_Rollback.sql"
   ```

---

## Conclusion

This plan provides a comprehensive roadmap for implementing 5 major features in ShiftManager. The estimated timeline is **3-4 weeks** for a single developer, with careful attention to multi-tenant isolation, role-based access control, and data integrity.

**Key Takeaways:**

1. **Prioritize dependencies:** Export (Feature 1) before Analytics (Feature 5)
2. **Test migrations thoroughly:** All new fields nullable for backward compatibility
3. **Validate permissions:** Strict checks in service layer (not just UI)
4. **Monitor background jobs:** Hangfire dashboard for health checks
5. **Performance matters:** Add indexes, paginate large result sets

**Next Steps:**

1. Review this plan with team/stakeholders
2. Create GitHub issues for each feature (link to this doc)
3. Set up project board (Kanban: To Do, In Progress, Review, Done)
4. Kick off Week 1 on Monday, October 13, 2025

---

**Document Version:** 1.0
**Last Updated:** 2025-10-06
**Status:** Ready for Implementation
**Estimated Total Effort:** 120-160 developer hours (3-4 weeks for 1 developer)
